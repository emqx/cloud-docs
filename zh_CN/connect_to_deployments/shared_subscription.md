# 共享订阅

共享订阅是在多个订阅者之间实现负载均衡的订阅方式，EMQX Cloud 采用 random 均衡策略，即在所有订阅者中随机选择一位订阅者获取消息。

::: tip
**重要提示：持久化会话（clean_session=false）和共享订阅不能同时使用**

如果您在使用共享订阅功能，请务必将客户端的 clean_session 设置为 true。

**原因如下：**

1. **持久化会话功能**允许订阅者在重新连接后立即恢复数据流而不丢失消息，这对于确保消息的可靠传递至关重要。然而，这与**负载平衡**的概念存在冲突。共享订阅通常允许一个设备离线时，组内的其他设备接管数据流。但是如果设备离线时间过长，持久化会话的消息缓冲区可能会溢出，导致消息丢失。

2. 当设置 clean_session=false 并且设备长时间离线时，消息可能会**持续堆积**。持久化会话导致消息继续被投递到设备，但设备并未处理这些消息。假设某个设备由于某种原因离线，但会话保持存在，此时其他消息发布者继续发送消息到该设备的会话中。由于设备离线，这些消息无法被设备及时处理，导致消息持续堆积在会话中。这些消息也不会被传递给其他设备，因为它们都被视为属于同一个设备的会话。随着时间的推移，消息堆积可能变得越来越严重，最终导致内存和存储资源的消耗增加，对系统的稳定性和性能产生负面影响。

**为确保系统的可靠性和资源的有效利用，在使用共享订阅时，请务必将 clean_session 设置为 true**。这将确保设备离线后，消息能够合理地在其他设备间共享，避免持续堆积和资源浪费。
:::

您可以查看[教程视频](https://player.bilibili.com/player.html?aid=254440768&bvid=BV1vY411G74L&cid=541242226&page=1)进一步了解。

## 共享订阅前缀格式

EMQX Cloud 支持两种格式的共享订阅前缀，分别为带群组的共享订阅（前缀为 `$share/<group-name>/`）和不带群组的共享订阅（前缀为 `$queue/`）。

两种共享订阅格式示例如下。

| 前缀格式     | 示例           | 前缀        | 真实主题名 |
| :----------- | :------------- | :---------- | :--------- |
| 带群组格式   | $share/abc/t/1 | $share/abc/ | t/1        |
| 不带群组格式 | $queue/t/1     | $queue/     | t/1        |

## 带群组的共享订阅

以 `$share/<group-name>/` 为前缀的共享订阅是带群组的共享订阅。
其中 group-name 可以为任意字符串，属于同一个群组内部的订阅者将以负载均衡接收消息，但 EMQX 会向不同群组广播消息。

### 示例

* 订阅者 s1，s2，s3 属于群组 g1，订阅 `$share/g1/test` 主题
* 订阅者 s4，s5 属于群组 g2，订阅 `$share/g2/test` 主题
* 订阅者 s6 为普通订阅 订阅 `test` 主题

那么当发送者向 EMQX Cloud 发送主题为 `test` 的消息msg时（注：发送者发送的主题无需带前缀）：

* 群组 g1 中 s1，s2，s3 只有一个会收到 msg
* 群组 g2 中 s4，s5 只有一个会收到 msg
* 订阅者 s6 可以正常收到 msg

## 不带群组的共享订阅

以 `$queue/` 为前缀的共享订阅是不带群组的共享订阅。
它是 $share 订阅的一种特例，相当与所有订阅者都在一个订阅组里面。

### 示例

* 订阅者 s1，s2，s3 为共享订阅 订阅 `$queue/test` 主题
* 订阅者 s4 为普通订阅 订阅 `test` 主题

那么当发送者向 EMQX Cloud 发送主题为 `test` 的消息msg时（注：发送者发送的主题无需带前缀）：

* 订阅者 s1，s2，s3 只有一个会收到 msg
* 订阅者 s4 可以正常收到 msg

## 使用 MQTTX 测试共享订阅

1. 使用 MQTTX 模拟客户端订阅。

* s1，s2 订阅主题 `$share/g1/test`，为带群组的共享订阅
* s3 订阅主题 `test` 为普通订阅

![shared_subscription_1](./_assets/shared_subscription_1.png)

2. 使用 MQTTX 创建客户端 p1 向主题 `test` 发送3条信息。

![shared_subscription_2](./_assets/shared_subscription_2.png)

3. 3个订阅者中，s1 接收到msg1，msg2，而 s2 接收到 msg3，s3 接收到所有3条 msg 信息。

![shared_subscription_3](./_assets/shared_subscription_3.png)
